#This file contains the halo profile data extracted from Latif+ papers using PlotDigitizer.

#PlotDigitizer, 3.3.9, 2025, https://plotdigitizer.com
# @misc{
# url = {https://plotdigitizer.com},
# title = {PlotDigitizer: Version 3.3.9},
# year = {2025}
# }

import numpy as np
from collections import defaultdict
from physical_constants import Omega_b, Omega_m
import matplotlib.pyplot as plt
import os
import copy

PC_TO_CM = 3.085677581e18
MSUN_G   = 1.98847e33
AU_TO_CM = 1.495978707e13
RUNIT_TO_CM = {
    "pc": PC_TO_CM,
    "au": AU_TO_CM,
}
def _radius_unit_of_density(store, halo, j21):
    blk = store[halo]["density"][float(j21)]
    unit = (blk.get("units", {}) or {}).get("r", "pc")
    return str(unit).strip().lower()

# --- dataset registry ---
STORE_REGISTRY: dict[str, dict] = {}

def register_store(name: str, store):
    """Register a dataset store under a simple name (case-insensitive)."""
    STORE_REGISTRY[name.lower()] = store

def get_store(name: str):
    """Fetch a registered dataset by name."""
    key = name.lower()
    if key not in STORE_REGISTRY:
        raise ValueError(f"Unknown dataset '{name}'. Available: {list(STORE_REGISTRY.keys())}")
    return STORE_REGISTRY[key]


# ---- basic container：halo -> quantity -> j21 -> {"r":..., "y":..., "units":...}

def make_store():
    """
    Create a profile/scalar store with the layout:
      store[halo][quantity][J21] -> {"r": array, "y": array, "units": {"r":..., "y":...}}
      store[halo][J21]           -> {"z_collapse":..., "M_collapse_Msun":..., "Tvir":..., ...}
    """
    return defaultdict(lambda: defaultdict(dict))

# Create per-paper stores
Latif2019_data  = make_store()
Latif2014A_data = make_store()
Latif2021_data = make_store()
register_store("Latif2019", Latif2019_data)
register_store("Latif2014A", Latif2014A_data)
register_store("Latif2021", Latif2021_data)


# ---------- key helpers ----------
def _jkey(j21) -> float:
    """Normalize J21 key to float to avoid 10 vs 10.0 mismatch."""
    return float(j21)

# ---------- add/read APIs (generic over store) ----------
def add_profile_to(store, halo, j21, quantity, r, y, r_unit="pc", y_unit=None):
    store[halo][quantity][_jkey(j21)] = {
        "r": np.asarray(r, float),
        "y": np.asarray(y, float),
        "units": {"r": r_unit, "y": y_unit},
    }

def set_scalar_in(store, halo, j21, name, value):
    store[halo][_jkey(j21)][name] = float(value)


# ------------------------------------------------------------
#                      Latif2019 data
# ------------------------------------------------------------

#Latif & Sadegh 2019 https://doi.org/10.1093/mnras/stz2812

#1. halo 6
#1.0 collapse properties
set_scalar_in(Latif2019_data, "halo6", 0.1, "z_collapse", 25.4)
set_scalar_in(Latif2019_data, "halo6", 0.1, "M_collapse_Msun", 7.6e5)
set_scalar_in(Latif2019_data, "halo6", 1.0, "z_collapse", 24.5)
set_scalar_in(Latif2019_data, "halo6", 1.0, "M_collapse_Msun", 1.2e6)
set_scalar_in(Latif2019_data, "halo6", 10.0, "z_collapse", 11.5)
set_scalar_in(Latif2019_data, "halo6", 10.0, "M_collapse_Msun", 5.7e7)
set_scalar_in(Latif2019_data, "halo6", 100.0, "z_collapse", 11.0)
set_scalar_in(Latif2019_data, "halo6", 100.0, "M_collapse_Msun", 6.3e7)
set_scalar_in(Latif2019_data, "halo6", 1000.0, "z_collapse", 10.6)
set_scalar_in(Latif2019_data, "halo6", 1000.0, "M_collapse_Msun", 6.7e7)

#1.1 M_enc profile
#(Menc, r) the same for J21=0.1 and 1.0
r01 = [0.00035, 0.00069, 0.00404, 0.0121, 0.10329, 1.0899, 7.85423, 45.46763, 379.38141, 1051.29983]
Menc01 = [0.01992, 0.30115, 16.70967, 69.69781, 320.09786, 2598.68239, 11766.59897, 34768.52715, 329098.2253, 2426517.68699]
add_profile_to(Latif2019_data, "halo6", 0.1, "M_enc",  r01, Menc01, r_unit="pc", y_unit="Msun")


add_profile_to(Latif2019_data, "halo6", 1.0, "M_enc",  r01, Menc01, r_unit="pc", y_unit="Msun")

r10 = [0.00056, 0.00164, 0.00452, 0.01914, 0.10766, 0.68431, 3.62174, 22.02055, 91.32361, 407.53673, 1484.40518]
Menc10 = [0.02091, 0.28719, 4.69984, 91.40065, 380.73462, 1755.5782, 9404.70814, 97885.65112, 725264.60559, 2583163.90617, 5338062.6527]
add_profile_to(Latif2019_data, "halo6", 10.0, "M_enc",  r10, Menc10, r_unit="pc", y_unit="Msun")

r100 = [0.00079, 0.0023, 0.00635, 0.02173, 0.08802, 0.48188, 1.62388, 8.6568, 48.09039, 247.64147, 1305.93423]
Menc100 = [0.04954, 0.86036, 9.60501, 118.22416, 697.33893, 2384.36329, 9064.68081, 36120.78278, 686441.63339, 2760925.10654, 5135942.1426]
add_profile_to(Latif2019_data, "halo6", 100.0, "M_enc",  r100, Menc100, r_unit="pc", y_unit="Msun")

r1e3 = [0.00045, 0.00102, 0.00299, 0.0093, 0.03864, 0.13931, 1.0459, 9.20296, 82.05128, 493.5039, 1848.25547]
Menc1e3 = [0.05776, 0.57917, 12.05993, 192.25975, 2386.47998, 14985.24882, 78619.98072, 361394.84373, 1494099.07065, 3944326.84803, 7615946.47632]
add_profile_to(Latif2019_data, "halo6", 1000.0, "M_enc",  r1e3, Menc1e3, r_unit="pc", y_unit="Msun")


#1.2 density profile
r01 = [0.00029, 0.00078, 0.00258, 0.00619, 0.01679, 0.04151, 0.1117, 0.42741, 0.78844, 1.32157, 2.0675, 4.10838, 7.80126, 24.54502, 83.34281, 210.55258, 593.11402, 1172.9761]
rho01 = 1.0e-24 * np.array([6676036375.4725, 5567284274.42254, 2941752221.67314, 1004635218.58635, 84964879.48948, 8549438.59941, 953025.53732, 129167.03329, 34624.77271, 22766.28197, 3072.93953, 508.66154, 64.72145, 5.50033, 1.15906, 0.21366, 0.04147, 0.02405])
add_profile_to(Latif2019_data, "halo6", 0.1, "density", r01, rho01, r_unit="pc", y_unit="g/cm^3")

r1 = [0.00029, 0.00078, 0.00258, 0.00718, 0.01919, 0.03995, 0.11464, 0.23425, 0.50577, 1.00734, 2.0675, 4.9583, 10.12032, 26.09247, 83.34281, 193.87067, 593.11402, 1172.9761]
rho1 = 1.0e-24*np.array([6676036375.4725, 5567284274.42254, 2941752221.67314, 1095622150.09972, 198226571.17579, 19775489.35551, 2148304.48494, 557040.58712, 35383.43833, 6297.38324, 3072.93953, 512.09462, 50.80204, 8.59027, 1.15906, 0.19954, 0.04147, 0.02405])
add_profile_to(Latif2019_data, "halo6", 1.0, "density", r1, rho1, r_unit="pc", y_unit="g/cm^3")

r10 = [0.00051, 0.00143, 0.0031, 0.00847, 0.02277, 0.04529, 0.11058, 0.32619, 0.76996, 1.7908, 2.82628, 5.73591, 9.27555, 17.04728, 44.64756, 91.84813, 475.44081, 1579.44347, 25.41432, 1004.94017]
rho10 = 1.0e-24*np.array([1095212795.11404, 1091127647.88932, 1008396540.90551, 341556983.36877, 90031637.12634, 14180280.55537, 1613533.47786, 200077.82296, 38200.62571, 34289.98263, 8164.97848, 13296.88224, 8713.53436, 1155.65551, 147.2641, 5.27685, 0.20822, 0.16344, 138.61337, 0.0823])
add_profile_to(Latif2019_data, "halo6", 10.0, "density", r10, rho10, r_unit="pc", y_unit="g/cm^3")

r100 = [0.00051, 0.00145, 0.00636, 0.03108, 0.8432, 0.11837, 0.27728, 1.5136, 2.82628, 5.29368, 9.55243, 112.70825, 475.44081, 1579.44347, 39.68564, 889.54949]
rho100 = 1.0e-24*np.array([1097717526.19304, 1096896621.25293, 656821109.84086, 142029271.05545, 63317.97653, 2467373.53578, 834868.35431, 53328.89635, 8091.95476, 2768.91762, 422.03676, 6.66972, 0.20429, 0.16031, 54.93343, 0.06053])
add_profile_to(Latif2019_data, "halo6", 100.0, "density", r100, rho100, r_unit="pc", y_unit="g/cm^3")

r1e3 = [0.0006, 0.00201, 0.01221, 0.05365, 1.83971, 0.1469, 0.37665, 3.38012, 9.1015, 112.70825, 361.61643, 1360.91106, 39.68564, 820.71265, 1816.7673]
rho1e3 = 1.0e-24*np.array([6842183804.26088, 5095471065.99368, 1926704050.31779, 259565424.94541, 76140.32924, 129931609.87845, 3785100.43162, 45151.52889, 1950.26949, 6.66972, 0.25964, 0.13855, 54.93343, 0.06698, 0.06272])
add_profile_to(Latif2019_data, "halo6", 1000.0, "density", r1e3, rho1e3, r_unit="pc", y_unit="g/cm^3")

#1.3 fH2 profile
r01 = [0.00029, 0.00076, 0.00154, 0.0036, 0.01057, 0.03824, 0.22964, 1.23441, 4.65921, 11.91119, 21.60988, 26.65703, 29.67299, 45.83186]
fH2_01 = [0.00536, 0.00565, 0.00459, 0.00312, 0.00196, 0.00133, 0.00104, 0.00087, 0.00055, 0.0002, 0.00007, 0.00003, 0.00002, 0.00001]
add_profile_to(Latif2019_data, "halo6", 0.1, "fH2", r01, fH2_01, r_unit="pc", y_unit=None)

r1 = [0.00042, 0.00083, 0.00168, 0.0036, 0.01057, 0.03824, 0.22964, 0.99363, 3.36506, 6.06289, 8.21556, 10.29322, 13.72205, 15.50683]
fH2_1 = [0.00444, 0.00389, 0.00341, 0.00312, 0.00196, 0.00133, 0.00104, 0.00062, 0.00047, 0.00031, 0.00012, 0.00006, 0.00002, 0.00001]
add_profile_to(Latif2019_data, "halo6", 1.0, "fH2", r1, fH2_1, r_unit="pc", y_unit=None)

r10 = [0.0005, 0.00193, 0.00542, 0.01464, 0.05303, 0.21793, 1.07813, 2.41321, 5.4761, 9.3343, 20.219, 42.07087, 65.86782, 79.97309]
fH2_10 = [0.00244, 0.0025, 0.00216, 0.00184, 0.00138, 0.00102, 0.0009, 0.00075, 0.00071, 0.0006, 0.0002, 0.00007, 0.00005, 0.00001]
add_profile_to(Latif2019_data, "halo6", 10.0, "fH2", r10, fH2_10, r_unit="pc", y_unit=None)

r100 = [0.00091, 0.0025, 0.00578, 0.01524, 0.04354, 0.13427, 0.32564, 0.79233, 1.31568, 2.29682, 4.54791, 5.92353, 7.22422, 8.54987]
fH2_100 = [0.00196, 0.00197, 0.0018, 0.00134, 0.00085, 0.00052, 0.0005, 0.00039, 0.0005, 0.00031, 0.00015, 0.00008, 0.00004, 0.00001]
add_profile_to(Latif2019_data, "halo6", 100.0, "fH2", r100, fH2_100, r_unit="pc", y_unit=None)

r1e3 = [2.14766, 2.2645, 2.88788, 3.95687, 4.9461, 5.10946]
fH2_1e3 = [0.00001, 0.00002, 0.00006, 0.00004, 0.00003, 0.00001]
add_profile_to(Latif2019_data, "halo6", 1000.0, "fH2", r1e3, fH2_1e3, r_unit="pc", y_unit=None)

#2. halo 1
set_scalar_in(Latif2019_data, "halo1", 0.1, "z_collapse", 24.5)
set_scalar_in(Latif2019_data, "halo1", 0.1, "M_collapse_Msun", 8.8e5)
set_scalar_in(Latif2019_data, "halo1", 1.0, "z_collapse", 23.9)
set_scalar_in(Latif2019_data, "halo1", 1.0, "M_collapse_Msun", 8.0e5)
set_scalar_in(Latif2019_data, "halo1", 5, "z_collapse", 15.4)
set_scalar_in(Latif2019_data, "halo1", 5, "M_collapse_Msun", 7.7e6)
set_scalar_in(Latif2019_data, "halo1", 10, "z_collapse", 15)
set_scalar_in(Latif2019_data, "halo1", 10, "M_collapse_Msun", 9.3e6)
set_scalar_in(Latif2019_data, "halo1", 50, "z_collapse", 12.6)
set_scalar_in(Latif2019_data, "halo1", 50, "M_collapse_Msun", 1.5e7)
set_scalar_in(Latif2019_data, "halo1", 100, "z_collapse", 11.7)
set_scalar_in(Latif2019_data, "halo1", 100, "M_collapse_Msun", 1.8e7)
set_scalar_in(Latif2019_data, "halo1", 1000, "z_collapse", 11.4)
set_scalar_in(Latif2019_data, "halo1", 1000, "M_collapse_Msun", 1.9e7)

#2.1 M_enc profile

#2.2 density profile
r0 = [0.00065, 0.00132, 0.00344, 0.01056, 0.02454, 0.05032, 0.15356, 0.65231, 2.17313, 7.86232, 17.92803, 111.31718, 648.16059, 60.8456, 305.52455, 406.6636, 525.52314, 846.30535]
rho0 = 1.0e-24*np.array([3518135780.27434, 3358307287.24769, 1817815986.08733, 596974873.72292, 79816641.99075, 14468155.76692, 1185138.9588, 53815.26286, 6764.4595, 247.67061, 29.91538, 1.19222, 0.17514, 3.64173, 0.52895, 14.93481, 0.87424, 0.0599])
add_profile_to(Latif2019_data, "halo1", 0.0, "density", r0, rho0, r_unit="pc", y_unit="g/cm^3")

r01 = [0.00034, 0.00127, 0.0032, 0.00674, 0.01694, 0.04054, 0.09879, 0.25853, 0.70681, 3.10899, 7.07326, 22.68678, 92.19933, 423.48338, 701.52518]
rho01 = 1.0e-24 * np.array([2876910403.77372, 2289087177.8256, 2282835188.42443, 1118060843.29187, 181950357.49772, 23809912.53676, 3168538.69654, 307388.37966, 26315.86303, 2327.18763, 163.30271, 12.06573, 1.74364, 0.97454, 0.1303])
add_profile_to(Latif2019_data, "halo1", 0.1, "density", r01, rho01, r_unit="pc", y_unit="g/cm^3")

r1 = [0.00033, 0.00086, 0.00318, 0.00674, 0.01757, 0.03593, 0.09879, 0.25853, 0.70681, 3.10899, 7.07326, 22.68678, 92.19933, 423.48338, 701.52518]
rho1 =1.0e-24 * np.array([5404968643.62274, 3512641828.02525, 2677348085.5781, 1118060843.29187, 168536988.63247, 16666257.24442, 3168538.69654, 307388.37966, 26315.86303, 2327.18763, 163.30271, 12.06573, 1.74364, 0.97454, 0.1303])
add_profile_to(Latif2019_data, "halo1", 1.0, "density", r1, rho1, r_unit="pc", y_unit="g/cm^3")

r5 = [0.00043246198102412666, 0.0016421900100564637, 0.006356727399716979, 0.02545564750584017, 0.09675351377944945, 0.3756625487879706, 0.5645354074640656, 0.7226755207462523, 1.1996168969384535, 2.4348336185338937, 5.321333228762902, 19.813218792892823, 112.35101706662647, 313.51895013443016, 808.7089589899316]
rho5 = 1.0e-24*np.array([1519793368.1251152, 1570724581.363684, 929572849.2847463, 98813668.47427365, 3606434.4225863963, 235015.6817276271, 3780627.572245374, 14505928.53943961, 230911.69653707076, 1599.5518666220332, 377.63230908395997, 14.284996980955503, 6.9094072447067205, 0.6679662135727504, 0.1653153922768664])
add_profile_to(Latif2019_data, "halo1", 5.0, "density", r5, rho5, r_unit="pc", y_unit="g/cm^3")

r10 = [0.00048230635070109886, 0.0016421900100564637, 0.006356727399716979, 0.015544691887878997, 0.042853200977141966, 0.09576208885577311, 0.2889577135438804, 0.6144569506852565, 1.2049620281730158, 2.872381660202119, 8.820838524856457, 22.498733393966585, 112.35101706662647, 313.51895013443016, 808.7089589899316]
rho10 =1.0e-24*np.array([2226636679.3744407, 1570724581.363684, 929572849.2847463, 333628602.60461193, 34139683.57738917, 2814897.544783489, 574903.9448900474, 161508.05385836613, 18952.83851578146, 1512.8956673206972, 254.11776584540104, 18.364374807450503, 6.9094072447067205, 0.6679662135727504, 0.1653153922768664])
add_profile_to(Latif2019_data, "halo1", 10.0, "density", r10, rho10, r_unit="pc", y_unit="g/cm^3")

r50 = [0.00048230635070109886, 0.0019395667532673823, 0.006356727399716979, 0.015544691887878997, 0.042853200977141966, 0.09576208885577311, 0.26666425448375003, 0.5110736539966564, 1.2049620281730158, 3.2724083825169683, 8.820838524856457, 29.010979367918175, 112.35101706662647, 313.51895013443016, 808.7089589899316]
rho50 = 1.0e-24*np.array([2226636679.3744407, 1743875674.4978206, 929572849.2847463, 333628602.60461193, 34139683.57738917, 2814897.544783489, 354445.5206094803, 69212.20025332393, 18952.83851578146, 3441.234588050047, 254.11776584540104, 49.536796541928545, 6.9094072447067205, 0.6679662135727504, 0.1653153922768664])
add_profile_to(Latif2019_data, "halo1", 50.0, "density", r50, rho50, r_unit="pc", y_unit="g/cm^3") 

r100 = [0.00044, 0.00108, 0.00315, 0.00713, 0.01694, 0.0442, 0.13708, 0.39575, 1.29814, 4.18251, 10.63536, 22.81536, 161.27474, 701.52518, 68.67869]
rho100 = 1.0e-24 * np.array([1692380846.95792, 1198585016.41695, 739217327.27461, 673577867.06067, 181950357.49772, 27213792.18295, 12683243.26118, 3129170.22792, 132130.93791, 10331.62066, 1445.40306, 194.92133, 2.44378, 0.1303, 21.97938])
add_profile_to(Latif2019_data, "halo1", 100.0, "density", r100, rho100, r_unit="pc", y_unit="g/cm^3")

r1000 = [0.00046, 0.00101, 0.00273, 0.00695, 0.01709, 0.05119, 0.13653, 0.39575, 1.29814, 4.18251, 10.63536, 22.81536, 161.27474, 701.52518, 68.67869]
rho1000 = 1.0e-24 * np.array([10008794781.14461, 8705731925.21613, 6084247081.14796, 2725901839.66557, 974019544.24272, 221377412.21515, 28253908.96922, 3129170.22792, 132130.93791, 10331.62066, 1445.40306, 194.92133, 2.44378, 0.1303, 21.97938])
add_profile_to(Latif2019_data, "halo1", 1000.0, "density", r1000, rho1000, r_unit="pc", y_unit="g/cm^3")


#2.3 fH2 profile
r0 = [0.00034, 0.00106, 0.0069, 0.02827, 0.16428, 0.84514, 3.83637, 10.33738, 22.98916, 48.29276, 203.35932, 420.68913, 108.95213, 718.95561]
fH2_0 = [0.00319, 0.00303, 0.00231, 0.00172, 0.0012, 0.00091, 0.00064, 0.00027, 0.00013, 0.00008, 0.00003, 0.00004, 0.00005, 0.00002]
add_profile_to(Latif2019_data, "halo1", 0.0, "fH2", r0, fH2_0, r_unit="pc", y_unit=None)

r01 = [0.0005, 0.00126, 0.00538, 0.02827, 0.16428, 0.84514, 3.83637, 10.33738, 18.58832, 26.10842, 34.6112, 67.00282]
fH2_01 = [0.0047, 0.00457, 0.00293, 0.00172, 0.0012, 0.00091, 0.00064, 0.00027, 0.00011, 0.00005, 0.00002, 0.00001]
add_profile_to(Latif2019_data, "halo1", 0.1, "fH2", r01, fH2_01, r_unit="pc", y_unit=None)

r1 = [0.00052, 0.00181, 0.00538, 0.02827, 0.14517, 0.72707, 2.42141, 6.78575, 11.75897, 15.13466, 18.14938, 21.30909]
fH2_1 = [0.0049, 0.00377, 0.00293, 0.00172, 0.00118, 0.00081, 0.00055, 0.00033, 0.00012, 0.00005, 0.00002, 0.00001]
add_profile_to(Latif2019_data, "halo1", 1.0, "fH2", r1, fH2_1, r_unit="pc", y_unit=None)

r5 = [0.0004259313185670526, 0.001781979519906398, 0.008337973634367963, 0.032533208411717626, 0.09196130011149084, 0.26641438975941195, 0.753425512147508, 2.02128638582587, 4.408469949003642, 7.11222710447131, 10.952162590337483]
fH2_5 = [0.0025798035219728433, 0.002726940442761194, 0.0022937804201509926, 0.0012494570657738211, 0.0008790724567173884, 0.0007558836102784575, 0.0006588162258881097, 0.00033378657622362126, 0.00011010232793485985, 0.00004342548791638736, 0.000013909966999458965]
add_profile_to(Latif2019_data, "halo1", 5.0, "fH2", r5, fH2_5, r_unit="pc", y_unit=None)

r10 = [0.0004259313185670526, 0.001781979519906398, 0.008337973634367963, 0.028572018763353055, 0.08663723831370905, 0.26641438975941195, 0.753425512147508, 2.02128638582587, 6.8633020185882065, 12.101289048093445, 17.52303792588523]
fH2_10 = [0.0025798035219728433, 0.002726940442761194, 0.0022937804201509926, 0.0016096665374605208, 0.0010868115206115558, 0.0007558836102784575, 0.0006588162258881097, 0.00033378657622362126, 0.0001682927654365427, 0.00004720885828812877, 0.000015167069933237267]
add_profile_to(Latif2019_data, "halo1", 10.0, "fH2", r10, fH2_10, r_unit="pc", y_unit=None)

r50 = [0.0004259313185670526, 0.001311725896316336, 0.00489318823087793, 0.011438479588721824, 0.04835809915590955, 0.13980362541767202, 0.35205329310918504, 0.979337288155285, 4.064052301267865, 8.335248419978672, 17.52303792588523]
fH2_50 = [0.0025798035219728433, 0.0027142099607280925, 0.0021724150541818097, 0.001333503252025404, 0.000868494963459788, 0.0005773901284339241, 0.00035082845640770007, 0.0002489501603186649, 0.00016512883414599767, 0.000050407135944191675, 0.000015167069933237267]
add_profile_to(Latif2019_data, "halo1", 50.0, "fH2", r50, fH2_50, r_unit="pc", y_unit=None)

r100 = [0.00042, 0.0015, 0.00466, 0.02041, 0.05138, 0.15228, 0.81539, 2.40737, 5.34509, 8.9421, 12.9866, 16.54554]
fH2_100 = [0.00266, 0.00196, 0.00162, 0.0013, 0.00076, 0.00035, 0.0001, 0.00019, 0.00023, 0.00007, 0.00003, 0.00001]
add_profile_to(Latif2019_data, "halo1", 100.0, "fH2", r100, fH2_100, r_unit="pc", y_unit=None)

r1000 = [0.00042, 0.00156, 0.00536, 0.02264, 0.14541, 0.49829, 0.67808, 1.06397, 1.80078, 2.25608, 3.25278, 4.53198]
fH2_1000 = [0.00266, 0.00275, 0.00265, 0.00214, 0.00158, 0.00085, 0.00039, 0.00016, 0.00007, 0.00003, 0.00002, 0.00001]
add_profile_to(Latif2019_data, "halo1", 1000.0, "fH2", r1000, fH2_1000, r_unit="pc", y_unit=None)


#https://doi.org/10.1093/mnras/stu1230
# ------------------------------------------------------------
#                     Latif2014A data
# ------------------------------------------------------------
Latif2014A_haloA = np.array([[300.0, 1.41e7, 14.24],
                  [600.0, 1.42e7, 14.23],
                  [700.0, 1.43e7, 14.22]])
for j21, m_collapse, z_collapse in Latif2014A_haloA:
    set_scalar_in(Latif2014A_data, "haloA", j21, "M_collapse_Msun", m_collapse)
    set_scalar_in(Latif2014A_data, "haloA", j21, "z_collapse", z_collapse)
Latif2014A_haloB = np.array([[600.0, 2.3e7, 12.98],
                    [900.0, 2.6e7, 12.84],
                    [1000.0, 2.4e7, 12.96],
                    [1500.0, 2.5e7, 12.97],
                    [2000.0, 2.4e7, 12.93]])
for j21, m_collapse, z_collapse in Latif2014A_haloB:
    set_scalar_in(Latif2014A_data, "haloB", j21, "M_collapse_Msun", m_collapse)
    set_scalar_in(Latif2014A_data, "haloB", j21, "z_collapse", z_collapse)
Latif2014A_haloC = np.array([[600.0, 3.22e7, 11.20],
                    [700.0, 3.26e7, 11.11],
                    [900.0, 3.24e7, 11.13]])
for j21, m_collapse, z_collapse in Latif2014A_haloC:
    set_scalar_in(Latif2014A_data, "haloC", j21, "M_collapse_Msun", m_collapse)
    set_scalar_in(Latif2014A_data, "haloC", j21, "z_collapse", z_collapse)
Latif2014A_haloD = np.array([[300.0, 4.06e7, 13.29],
                    [400.0, 4.08e7, 13.28],
                    [500.0, 4.08e7, 13.27],
                    [600.0, 4.1e7, 13.24]])
for j21, m_collapse, z_collapse in Latif2014A_haloD:
    set_scalar_in(Latif2014A_data, "haloD", j21, "M_collapse_Msun", m_collapse)
    set_scalar_in(Latif2014A_data, "haloD", j21, "z_collapse", z_collapse)
Latif2014A_haloE = np.array([[300.0, 5.46e7, 10.60],
                    [500.0, 5.56e7, 10.549],
                    [600.0, 5.47e7, 10.59]])
for j21, m_collapse, z_collapse in Latif2014A_haloE:
    set_scalar_in(Latif2014A_data, "haloE", j21, "M_collapse_Msun", m_collapse)
    set_scalar_in(Latif2014A_data, "haloE", j21, "z_collapse", z_collapse)


#halo A
#density profile
r300 = [1823.81329, 3349.14662, 6068.51902, 13709.81795, 37398.01281, 66109.59427, 126153.0301, 198282.45447, 471571.97241, 976863.25156, 1657871.52992]
rho300 = 1.0e-24 * np.array( [10274067.72607, 9509475.53927, 7106265.25189, 3414548.87383, 1877088.93001, 836030.69365, 511491.45626, 67165.53287, 25769.80375, 7058.9056, 1829.67409])
add_profile_to(Latif2014A_data, "haloA", 300.0, "density", r300, rho300, r_unit="au", y_unit="g/cm^3")

r600 = [1498.79641, 3282.98423, 6068.51902, 14720.64454, 37398.01281, 66109.59427, 126153.0301, 257755.73492, 445768.51756, 976863.25156, 1657871.52992]
rho600 = 1.0e-24 * np.array( [18398089.5026, 11129217.92246, 7106265.25189, 4814772.34728, 1877088.93001, 836030.69365, 511491.45626, 457460.43157, 75470.59567, 7058.9056, 1829.67409])
add_profile_to(Latif2014A_data, "haloA", 600.0, "density", r600, rho600, r_unit="au", y_unit="g/cm^3")

r700 = [1748.81337, 3245.52378, 6668.10595, 15801.8775, 36323.71824, 74347.35792, 118668.4393, 245822.15283, 471172.40656, 976863.25156, 1657871.52992]
rho700 = 1.0e-24 * np.array( [124581783.94658, 101641416.08213, 79156183.84078, 37398444.17544, 14340544.99783, 4333798.22, 1393772.5893, 322729.29097, 54321.87445, 7058.9056, 1829.67409])
add_profile_to(Latif2014A_data, "haloA", 700.0, "density", r700, rho700, r_unit="au", y_unit="g/cm^3")


#fH2 profile
r300 = [1962.53128, 3706.04325, 7203.54705, 20658.75252, 47569.16184, 82798.96624, 127366.00581, 187725.53331, 355100.82802, 578074.91599, 747222.43438, 1036556.02391, 1300109.1987, 1676597.01441]
fH2_300 = 1.0e-8 * np.array([121572.71898, 106856.61728, 106856.61728, 86436.98254, 89679.78935, 48576.38297, 35928.04529, 6922.44103, 1266.20432, 492.59345, 145.36466, 32.15821, 3.54555, 1.49986])
add_profile_to(Latif2014A_data, "haloA", 300.0, "fH2", r300, fH2_300, r_unit="au", y_unit=None)

r600 = [1659.13144, 3109.1484, 5911.16547, 13539.61925, 25039.9125, 49668.6129, 99947.97918, 188373.79172, 248226.19102, 322280.64984, 445243.40693, 498174.42695, 553424.14872, 629858.44875, 723077.36845, 927085.03957, 1575212.16906]
fH2_600 = 1.0e-8 * np.array([192165.62802, 168093.20358, 155144.91521, 159346.2139, 81447.47652, 17979.17441, 2938.24796, 679.61315, 110.95894, 11.53853, 2.04552, 13.1529, 92.92115, 13.51884, 1.32084, 0.73501, 0.76922])
add_profile_to(Latif2014A_data, "haloA", 600.0, "fH2", r600, fH2_600, r_unit="au", y_unit=None)

r700 = [2211.8938, 13362.89015, 42176.16509, 51084.02123, 60910.94643, 82091.1248, 108089.71118, 129327.76137, 220471.20853, 290238.67945, 332090.50736, 386986.00804, 490330.5686, 835781.19678, 1575212.16906, 4053.02648]
fH2_700 = 1.0e-8 * np.array([0.18607, 0.22251, 0.35622, 5.92336, 654.25053, 1839.28487, 1049.95293, 4232.2827, 2880.12559, 601.09784, 28.42246, 2.43262, 0.60743, 0.60933, 0.76922, 0.22776])
add_profile_to(Latif2014A_data, "haloA", 700.0, "fH2", r700, fH2_700, r_unit="au", y_unit=None)


#halo B
#density profile
r600 = [1241.63781, 2196.87314, 5411.83889, 16304.58767, 33745.04446, 59571.74765, 84496.43866, 155780.76466, 323957.99653, 607895.53491, 1095012.52594, 1673310.48732]
rho600 = 1.0e-24 * np.array( [18090583.48143, 15176955.78811, 8119638.8789, 5802062.43324, 2644704.05382, 826324.44401, 1026188.76396, 420304.78169, 186750.08487, 63884.31529, 14917.63004, 4375.07935])
add_profile_to(Latif2014A_data, "haloB", 600.0, "density", r600, rho600, r_unit="au", y_unit="g/cm^3")

r900 = [1241.63781, 2196.87314, 5411.83889, 15024.83079, 38083.77339, 63933.495, 112304.62672, 214160.79598, 323957.99653, 607895.53491, 1095012.52594, 1673310.48732]
rho900 = 1.0e-24 * np.array( [18090583.48143, 15176955.78811, 8119638.8789, 5329352.04373, 7486974.64052, 5069839.29056, 2625130.26021, 723545.31788, 186750.08487, 63884.31529, 14917.63004, 4375.07935])
add_profile_to(Latif2014A_data, "haloB", 900.0, "density", r900, rho900, r_unit="au", y_unit="g/cm^3")

r1000 = [1241.63781, 2196.87314, 5411.83889, 13904.44079, 34524.10324, 71719.33234, 124460.70966, 214160.79598, 388442.6236, 607895.53491, 1095012.52594, 1673310.48732]
rho1000 = 1.0e-24 * np.array( [18090583.48143, 15176955.78811, 8119638.8789, 3266862.49918, 2324025.05207, 1814981.12335, 1258214.85133, 723545.31788, 409578.42889, 63884.31529, 14917.63004, 4375.07935])
add_profile_to(Latif2014A_data, "haloB", 1000.0, "density", r1000, rho1000, r_unit="au", y_unit="g/cm^3")

r1500 = [1241.63781, 2196.87314, 4914.14166, 13904.44079, 34524.10324, 71719.33234, 123892.21842, 200785.18892, 325228.65019, 607895.53491, 1095012.52594, 1673310.48732]
rho1500 = 1.0e-24 * np.array( [18090583.48143, 15176955.78811, 5706313.90797, 3266862.49918, 2324025.05207, 1814981.12335, 865787.43536, 303567.85011, 155143.75131, 63884.31529, 14917.63004, 4375.07935])
add_profile_to(Latif2014A_data, "haloB", 1500.0, "density", r1500, rho1500, r_unit="au", y_unit="g/cm^3")

r2000 = [1294.29477, 2481.3083, 5435.95024, 13273.4232, 31662.66655, 70591.01455, 120607.38606, 203318.89076, 337159.50536, 546995.92891, 974391.05228, 1673310.48732]
rho2000 = 1.0e-24 * np.array( [157138785.20135, 138784494.28346, 86142495.20943, 79477682.12568, 17281404.76882, 5592169.58291, 2163415.90419, 934494.71293, 196718.12079, 47915.37595, 13576.60954, 4375.07935])
add_profile_to(Latif2014A_data, "haloB", 2000.0, "density", r2000, rho2000, r_unit="au", y_unit="g/cm^3")

#fH2 profile
r600 = [1282.53647, 2303.70769, 5387.43761, 13244.28595, 31341.46985, 59922.68674, 116522.13556, 168510.3177, 230096.97557, 335983.58104, 453294.51136, 512631.87809, 567046.69324, 801934.45071, 1265743.18957, 1841755.81338]
fH2_600 = 1.0e-8 * np.array([191197.00606, 200111.23834, 204022.03549, 156552.03673, 129955.52692, 31940.06519, 17955.16905, 3306.67409, 284.6609, 32.40907, 278.52118, 27.00878, 1.71848, 0.64072, 0.75354, 0.62201])
add_profile_to(Latif2014A_data, "haloB", 600.0, "fH2", r600, fH2_600, r_unit="au", y_unit=None)

r900 = [1282.53647, 2180.64029, 3944.67987, 8815.08107, 14484.60573, 19914.76083, 28925.89809, 33475.38877, 43391.08136, 68931.70992, 78809.4756, 421632.082, 866896.29585, 1265743.18957, 1841755.81338, 132771.39303, 159888.07805, 191502.69047, 276981.22162, 336583.44252, 547281.83327, 711785.58071]
fH2_900 = 1.0e-8 * np.array([191197.00606, 146531.41169, 106668.54932, 49206.82268, 13112.28418, 1424.95496, 212.36037, 7.2024, 0.65887, 1.35931, 11.79109, 59.97128, 4.63174, 0.75354, 0.62201, 2.62939, 114.28467, 33.46609, 32.3694, 3.47146, 361.11221, 27.48944])    
add_profile_to(Latif2014A_data, "haloB", 900.0, "fH2", r900, fH2_900, r_unit="au", y_unit=None)

r1000 = [1224.97871, 2065.92092, 4001.63988, 7504.67268, 13023.02879, 21267.86915, 37461.80468, 57052.26151, 71166.80273, 526359.59959, 795391.63636, 996438.76158, 1841755.81338, 109563.82076, 168254.45547, 212840.33882, 336583.44252, 586129.64527, 682406.99342]
fH2_1000 = 1.0e-8 * np.array([107508.1002, 117910.90464, 72112.28494, 21215.2361, 11637.55037, 3947.46749, 2047.7318, 421.89672, 21.65901, 32.67216, 4.85007, 0.7806, 0.62201, 1.0382, 1.66094, 5.79421, 3.47146, 307.19787, 30.44631])
add_profile_to(Latif2014A_data, "haloB", 1000.0, "fH2", r1000, fH2_1000, r_unit="au", y_unit=None)

r1500 = [1224.97871, 2065.92092, 4001.63988, 7765.43338, 14346.51074, 23650.07815, 42078.3336, 63287.77798, 97523.94359, 470721.23476, 770818.54639, 1700593.00098, 125305.46616, 173045.70342, 221651.6876, 282339.15253, 359049.11674]
fH2_1500 = 1.0e-8 * np.array([107508.1002, 117910.90464, 72112.28494, 43363.36191, 31427.75805, 16307.00916, 9378.28035, 2112.44724, 376.10107, 0.64799, 0.45391, 0.47682, 63.83741, 314.58572, 17.65203, 0.72885, 2.42279])
add_profile_to(Latif2014A_data, "haloB", 1500.0, "fH2", r1500, fH2_1500, r_unit="au", y_unit=None)

r2000 = [1565.74347, 2421.69133, 4666.64853, 12043.9503, 19635.18208, 27573.05586, 45315.97671, 64184.67074, 460387.1166, 770818.54639, 1700593.00098, 80647.71492, 98997.54326, 209977.13735, 267892.58411, 341285.73865, 131019.92614, 167025.09328]
fH2_2000 = 1.0e-8 * np.array([0.17178, 0.17975, 0.19801, 0.24765, 0.27869, 3.00572, 0.47333, 0.92098, 0.41538, 0.45391, 0.47682, 25.34201, 38.77496, 2.3092, 3.80084, 1.61797, 4.8727, 107.73221])
add_profile_to(Latif2014A_data, "haloB", 2000.0, "fH2", r2000, fH2_2000, r_unit="au", y_unit=None)


#halo C
#density profile
r600 = [2542.55431, 4746.46364, 13688.10271, 28612.67617, 59943.13524, 134403.4157, 342298.38993, 824165.08165, 1592134.62844]
rho600 = 1.0e-24*np.array([8843574.48578, 9069980.86112, 2229566.84953, 1618864.97898, 941938.67106, 224323.58262, 136026.55174, 110214.56785, 5619.66043])
add_profile_to(Latif2014A_data, "haloC", 600.0, "density", r600, rho600, r_unit="au", y_unit="g/cm^3")

r700 = [2542.55431, 4746.46364, 12381.72107, 28442.75421, 59943.13524, 162858.24379, 342298.38993, 700170.83195, 1578913.08681]
rho700 = 1.0e-24*np.array([8843574.48578, 9069980.86112, 5689115.00439, 3252969.40276, 941938.67106, 455437.16983, 136026.55174, 16789.36021, 3526.16835])
add_profile_to(Latif2014A_data, "haloC", 700.0, "density", r700, rho700, r_unit="au", y_unit="g/cm^3")

r900 = [1181.49334, 3727.76289, 12347.35197, 32191.65082, 70028.2054, 162858.24379, 328476.25735, 700170.83195, 1452819.19196]
rho900 = 1.0e-24*np.array([123757110.86058, 123449055.51131, 53795068.9343, 16268579.64927, 3608082.83206, 455437.16983, 92011.68879, 16789.36021, 3094.24611])
add_profile_to(Latif2014A_data, "haloC", 900.0, "density", r900, rho900, r_unit="au", y_unit="g/cm^3")

#fH2 profile
r600 = [2441.73481, 5653.34729, 20271.17193, 56178.04275, 104338.67632, 207294.09067, 363614.11389, 454188.33432, 589486.16233, 713010.91658, 895394.50212, 1276209.34212, 1715322.3478]
fH2_600 = 1.0e-8*np.array([179908.04579, 173325.72118, 119536.68408, 63451.36697, 5015.02387, 379.73137, 34.36759, 1.25321, 12.57762, 467.09737, 57.16395, 8.17844, 0.76807])
add_profile_to(Latif2014A_data, "haloC", 600.0, "fH2", r600, fH2_600, r_unit="au", y_unit=None)

r700 = [2441.73481, 5653.34729, 17149.11572, 39323.63263, 60992.77787, 101869.41801, 136701.79529, 166765.669, 323014.97847, 611976.32757, 1049317.7289, 1666858.06259]
fH2_700 = 1.0e-8*np.array([179908.04579, 173325.72118, 90464.8455, 49271.61029, 4548.59204, 944.43622, 43.7246, 0.68844, 0.47974, 0.51564, 0.46191, 0.55015])
add_profile_to(Latif2014A_data, "haloC", 700.0, "fH2", r700, fH2_700, r_unit="au", y_unit=None)

r900 = [1163.97994, 2611.51204, 6236.15836, 15796.63536, 37685.44394, 75501.53113, 120059.93392, 274599.98312, 370559.46914, 507614.00632, 1049317.7289, 1666858.06259]
fH2_900 = 1.0e-8*np.array([0.15246, 0.18738, 0.21204, 0.21571, 0.28911, 0.83613, 0.61125, 0.53745, 5.09766, 0.45191, 0.46191, 0.55015])
add_profile_to(Latif2014A_data, "haloC", 900.0, "fH2", r900, fH2_900, r_unit="au", y_unit=None)

# ------------------------------------------------------------
#                     Latif2021 data
# https://doi.org/10.1093/mnras/stab2708
# ------------------------------------------------------------

Latif2021_halo1 = np.array([100.0, 7.5e6, 16.5])
set_scalar_in(Latif2021_data, "halo1", 100.0, "M_collapse_Msun", 7.5e6)
set_scalar_in(Latif2021_data, "halo1", 100.0, "z_collapse", 16.5)
Latif2021_halo2 = np.array([500.0, 1.7e7, 14.5])
set_scalar_in(Latif2021_data, "halo2", 500.0, "M_collapse_Msun", 1.7e7)
set_scalar_in(Latif2021_data, "halo2", 500.0, "z_collapse", 14.5)
Latif2021_halo3 = np.array([100.0, 1.5e6, 22.8])
set_scalar_in(Latif2021_data, "halo3", 100.0, "M_collapse_Msun", 1.5e6)
set_scalar_in(Latif2021_data, "halo3", 100.0, "z_collapse", 22.8)
Latif2021_halo4 = np.array([500.0, 5.4e6, 18.5])
set_scalar_in(Latif2021_data, "halo4", 500.0, "M_collapse_Msun", 5.4e6)
set_scalar_in(Latif2021_data, "halo4", 500.0, "z_collapse", 18.5)
Latif2021_halo5 = np.array([100.0, 1.3e7, 13.3])
set_scalar_in(Latif2021_data, "halo5", 100.0, "M_collapse_Msun", 1.3e7)
set_scalar_in(Latif2021_data, "halo5", 100.0, "z_collapse", 13.3)
Latif2021_halo6 = np.array([500.0, 1.7e7, 13.31])
set_scalar_in(Latif2021_data, "halo6", 500.0, "M_collapse_Msun", 1.7e7)
set_scalar_in(Latif2021_data, "halo6", 500.0, "z_collapse", 13.31)

#halo1
r = [0.00281, 0.00563, 0.01351, 0.05068, 0.14587, 0.39416, 1.55556, 4.52684, 11.4988, 20.47375, 65.86484, 144.72404]
rho = 1.0e-22 * np.array([418993.32908, 437165.47875, 323265.55736, 132570.35194, 24299.74143, 1567.63233, 81.4856, 10.93242, 2.59789, 0.43783, 0.06956, 0.02399])
add_profile_to(Latif2021_data, "halo1", 100.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

r = [0.00303, 0.0086, 0.02758, 0.08376, 0.47317, 2.10846, 5.47775, 10.32134, 12.91992]
fH2 = [0.00136, 0.00132, 0.00124, 0.00099, 0.00072, 0.00043, 0.00029, 0.00014, 0.0001]
add_profile_to(Latif2021_data, "halo1", 100.0, "fH2", r, fH2, r_unit="pc", y_unit=None)

#halo2
r = [0.0032, 0.00594, 0.01351, 0.05068, 0.14587, 0.39178, 1.27059, 3.1449, 24.25116, 60.14012, 144.72404, 6.03497, 9.57154, 83.63833]
rho = 1.0e-22 * np.array([332391.89037, 334713.45103, 323265.55736, 132570.35194, 24299.74143, 2205.77033, 574.46485, 113.30741, 1.10902, 0.85227, 0.02399, 42.14306, 6.73337, 0.16979])
add_profile_to(Latif2021_data, "halo2", 500.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

r = [0.00376, 0.00969, 0.02807, 0.09365, 0.38188, 1.39553, 4.4054, 7.49842, 12.91992]
fH2 = [0.0018, 0.00172, 0.0015, 0.00133, 0.00108, 0.00078, 0.00053, 0.00025, 0.0001]
add_profile_to(Latif2021_data, "halo2", 500.0, "fH2", r, fH2, r_unit="pc", y_unit=None)

#halo3
r = [0.00338, 0.00677, 0.0177, 0.04894, 0.14876, 0.40966, 0.87107, 2.45956, 22.54923, 40.0257, 91.68744, 5.61741, 9.80619, 65.38385]
rho = 1.0e-22 * np.array([823216.83767, 779716.67944, 811083.78569, 387482.05402, 46378.21323, 4400.65649, 344.90236, 62.49043, 0.64666, 0.14034, 0.02482, 21.98873, 3.40016, 0.05225])
add_profile_to(Latif2021_data, "halo3", 100.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

r = [0.00356, 0.00938, 0.02807, 0.09099, 0.35166, 1.13131, 3.8761, 7.49842, 14.90892]
fH2 = [0.00167, 0.00163, 0.0015, 0.00118, 0.00087, 0.0006, 0.00041, 0.00025, 0.00012]
add_profile_to(Latif2021_data, "halo3", 100.0, "fH2", r, fH2, r_unit="pc", y_unit=None)

#halo4
r = [0.00327, 0.00697, 0.01503, 0.03673, 0.09886, 0.27392, 0.87107, 2.45956, 21.65026, 36.25297, 136.49657, 6.02728, 14.28416, 61.28155]
rho = 1.0e-22 * np.array([383368.75615, 393369.67466, 363026.67464, 248946.31116, 26880.13663, 3040.24715, 344.90236, 62.49043, 3.0809, 0.50392, 0.02539, 24.90041, 18.1246, 0.12036])
add_profile_to(Latif2021_data, "halo4", 500.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

r = [0.00321, 0.01488, 0.06264, 0.30127, 1.13131, 3.88105, 8.90266, 15.82941, 19.7643]
fH2 = [0.00157, 0.0015, 0.00115, 0.00078, 0.0006, 0.00046, 0.00035, 0.00021, 0.00011]
add_profile_to(Latif2021_data, "halo4", 500.0, "fH2", r, fH2, r_unit="pc", y_unit=None)

#halo5
r = [0.0033, 0.00922, 0.01981, 0.07387, 0.18001, 0.47671, 1.21231, 2.84817, 32.10125, 51.18957, 147.64324, 8.02762, 15.42441, 93.67605]
rho = 1.0e-22 * np.array([195849.15895, 174438.91083, 183488.41751, 74276.79743, 18190.95133, 3428.48015, 646.4715, 177.51106, 17.77893, 5.93912, 0.0457, 147.9552, 24.127, 0.98161])
add_profile_to(Latif2021_data, "halo5", 100.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

r = [0.00346, 0.01439, 0.07319, 0.33829, 1.44455, 5.09604, 12.33913, 29.65563, 47.91164, 75.15364]
fH2 = [0.00171, 0.00167, 0.00151, 0.00131, 0.00116, 0.00102, 0.00073, 0.00054, 0.00032, 0.00012]
add_profile_to(Latif2021_data, "halo5", 100.0, "fH2", r, fH2, r_unit="pc", y_unit=None)

#halo6
r = [0.00509, 0.01313, 0.07387, 0.16967, 0.32154, 0.7472, 2.04254, 24.65899, 43.53411, 147.64324, 5.03042, 11.5355, 93.67605, 0.02862]
rho = 1.0e-22 * np.array([3.89967, 3.86164, 3.37945, 2.83843, 2.39588, 1.92074, 1.59876, 1.48569, 1.21723, 0.71532, 1.39765, 1.50467, 0.99799, 3.64684])
add_profile_to(Latif2021_data, "halo6", 500.0, "density", r, rho, r_unit="pc", y_unit="g/cm^3")

x = [0.00421, 0.01249, 0.05401, 0.18149, 0.52475, 1.23126, 3.26333, 8.56864, 18.08485, 38.07647, 53.21891]
fH2 = [0.00125, 0.0012, 0.00103, 0.00075, 0.00052, 0.00044, 0.00025, 0.00026, 0.00031, 0.00018, 0.00011]
add_profile_to(Latif2021_data, "halo6", 500.0, "fH2", x, fH2, r_unit="pc", y_unit=None)

# ------------------------------------------------------------
#                      Data analysis routines
# ------------------------------------------------------------

def _get_raw_xy(halo: str, j21: float, quantity: str, store=None):
    """
    Fetch raw (r, y) from the given store and make it well-behaved:
    - remove non-finite points
    - sort by radius ascending
    - drop duplicate radii (keep first)
    Returns (r_sorted_unique, y_aligned).
    """
    if store is None:
        raise ValueError("No data store provided.")

    block = store[halo][quantity][float(j21)]
    r = np.asarray(block["r"], float)
    y = np.asarray(block["y"], float)

    m = np.isfinite(r) & np.isfinite(y)
    r, y = r[m], y[m]
    order = np.argsort(r)
    r, y = r[order], y[order]
    r_unique, idx = np.unique(r, return_index=True)
    y_unique = y[idx]
    return r_unique, y_unique



def _interp_log_clamped(x, y, x_eval, *, floor=None, ceil=None):
    """
    Interpolate y(x) at x_eval.

    Behavior:
    - Clean input (finite-only, sort by x ascending, drop duplicate x).
    - Prefer log–log interpolation if x>0 and y>0; otherwise fall back to linear.
    - Extrapolation:
        * if `floor` is not None: outside-range values are set to `floor`
        * else: endpoint-constant (clamped to y(xmin)/y(xmax))
    - Finally apply optional floor/ceil bounds to the entire result.
    """
    x = np.asarray(x, float); y = np.asarray(y, float)
    x_eval = np.asarray(x_eval, float)

    # --- clean: keep finite, sort, unique ---
    m = np.isfinite(x) & np.isfinite(y)
    x, y = x[m], y[m]
    if x.size == 0:
        raise ValueError("Empty input arrays after removing non-finite values.")
    order = np.argsort(x)
    x, y = x[order], y[order]
    xu, idx = np.unique(x, return_index=True)
    yu = y[idx]
    x, y = xu, yu

    # degenerate cases
    if x.size == 1:
        y_out = np.full_like(x_eval, y[0], dtype=float)
        if floor is not None: y_out = np.maximum(y_out, floor)
        if ceil  is not None: y_out = np.minimum(y_out, ceil)
        return y_out

    xmin, xmax = x[0], x[-1]
    inside = (x_eval >= xmin) & (x_eval <= xmax)
    left   = (x_eval <  xmin)
    right  = (x_eval >  xmax)

    # decide log vs linear space (ensure positivity if using log)
    use_log = np.all(x > 0)
    y_for_interp = y
    if use_log and (floor is not None and floor > 0):
        # keep y strictly positive for log interpolation when a positive floor is used
        y_for_interp = np.maximum(y_for_interp, floor)
    use_log = use_log and np.all(y_for_interp > 0)

    # interpolate on inside points
    if use_log:
        xi = np.log10(x); yi = np.log10(y_for_interp)
        y_inside = 10.0**np.interp(np.log10(x_eval[inside]), xi, yi)
    else:
        y_inside = np.interp(x_eval[inside], x, y)

    # assemble output
    y_out = np.empty_like(x_eval, dtype=float)
    y_out[inside] = y_inside

    # outside-range handling
    if floor is not None:
        # For fH2-like usage: directly set to floor outside the data range
        y_out[left]  = floor
        y_out[right] = floor
    else:
        # For other quantities: endpoint-constant (clamped)
        y_out[left]  = y[0]
        y_out[right] = y[-1]

    # global bounds
    if floor is not None: y_out = np.maximum(y_out, floor)
    if ceil  is not None: y_out = np.minimum(y_out, ceil)

    return y_out


def _build_r_grid(r_min, r_max, n_samples):
    """Log-spaced radius grid in the SAME unit as r_min/r_max."""
    return np.logspace(np.log10(r_min), np.log10(r_max), int(n_samples))


# ------------------------------
# 1) Mass-weighted H2 fraction
# ------------------------------

def mass_weighted_fH2(halo: str,
                      j21: float,
                      r_min: float = 1e-6,
                      r_max: float = 1e3,
                      n_samples: int = 1000,
                      fH2_floor: float = 1.0e-7,
                      store=None):
    """
    Compute mass-weighted <f_H2> and total gas mass over [r_min, r_max].
    NOTE: r_min/r_max MUST use the same unit as the profiles in `store` (AU for 2014A; pc for 2019).
    Only the mass integral converts radius to cm based on the density profile's radius unit.
    """
    if store is None:
        raise ValueError("No data store provided.")

    # raw profiles (r in their native unit)
    r_rho, rho = _get_raw_xy(halo, j21, "density", store=store)
    r_fh2, fh2 = _get_raw_xy(halo, j21, "fH2",      store=store)

    # evaluation grid (same unit as you pass in r_min/r_max)
    r_grid = _build_r_grid(r_min, r_max, n_samples)

    # interpolation in native unit
    rho_eval = _interp_log_clamped(r_rho, rho, r_grid)
    fH2_eval = _interp_log_clamped(r_fh2, np.maximum(fh2, fH2_floor), r_grid, floor=fH2_floor)

    # --- ONLY HERE: convert r->cm for the mass integral ---
    r_unit = _radius_unit_of_density(store, halo, j21)
    try:
        to_cm = RUNIT_TO_CM[r_unit]
    except KeyError:
        raise ValueError(f"Unsupported radius unit for density: {r_unit!r}. "
                         f"Supported: {list(RUNIT_TO_CM.keys())}")
    r_cm = r_grid * to_cm

    dMdr = 4.0 * np.pi * (r_cm**2) * rho_eval
    M_g  = np.trapezoid(dMdr, r_cm)
    fH2_avg = np.trapezoid(fH2_eval * dMdr, r_cm) / M_g

    return {
        "r": r_grid,               # native unit grid you used
        "r_unit": r_unit,          # report the unit for clarity
        "density": rho_eval,
        "fH2": fH2_eval,
        "fH2_avg": fH2_avg,
        "Mgas_Msun": M_g / MSUN_G,
    }


#plot and compare profile for different j21
def plot_profiles(halo: str, quantity: str, j21_list: list,
                  r_min_pc=1e-3, r_max_pc=1e3, n_samples=1000, store=None):
    if store is None:
        store = Latif2019_data

    outputdir = "/home/zwu/21cm_project/unified_model/Analytic_results/Latif/"
    color_map_halo6 = {0.1:"green", 1.0:"blue", 10.0:"cyan", 100.0:"magenta", 1000.0:"red"}
    color_map_halo1 = {0.0:"green", 0.1:"blue", 1.0:"blue", 5.0:"cyan", 10.0:"magenta",
                       50.0:"red", 100.0:"green", 1000.0:"red"}
    linestyle_halo1 = {0.0:"dotted", 0.1:"dashed", 1.0:"solid", 5.0:"solid", 10.0:"solid",
                       50.0:"solid", 100.0:"solid", 1000.0:"dotted"}

    plt.figure(figsize=(8,6))
    for j21 in j21_list:
        r, y = _get_raw_xy(halo, j21, quantity, store=store)
        r_eval = _build_r_grid(r_min_pc, r_max_pc, n_samples)
        if quantity == "fH2":
            y_eval = _interp_log_clamped(r, y, r_eval, floor=5e-6)
        else:
            y_eval = _interp_log_clamped(r, y, r_eval)

        if halo == "halo6":
            color = color_map_halo6.get(float(j21), "black")
            plt.plot(r_eval, y_eval, label=f"J21={j21}", color=color)
        elif halo == "halo1":
            color = color_map_halo1.get(float(j21), "black")
            linestyle = linestyle_halo1.get(float(j21), "solid")
            plt.plot(r_eval, y_eval, label=f"J21={j21}", color=color, linestyle=linestyle)
        else:
            plt.plot(r_eval, y_eval, label=f"J21={j21}")

    plt.xscale('log'); plt.yscale('log')
    plt.xlabel("Radius (pc)")
    unit = store[halo][quantity][float(j21_list[0])]['units']['y']
    plt.ylabel(f"{quantity} ({unit})" if unit else f"{quantity} (dimensionless)")
    plt.title(f"{quantity} profile for {halo}")
    plt.legend()
    plt.grid(True, which="both", ls="--", lw=0.5)

    filename = os.path.join(outputdir, f"{halo}_{quantity}_profile.png")
    plt.savefig(filename, dpi=300); plt.close()
    print(f"Saved plot to {filename}")

# ------------------------------------------------------------

if __name__ == "__main__":
    # Choose which paper's dataset to use
    store = Latif2019_data   # or: store = Latif2014A_data

    halo_name = "halo6"
    j21_val  = 1000.0

    # Compute mass-weighted <f_H2> and total gas mass (Msun)
    res = mass_weighted_fH2(
        halo_name, j21_val,
        r_min_pc=1e-3, r_max_pc=1e3, n_samples=1000,
        fH2_floor=5e-6,
        store=store,                 # <-- pass store explicitly
    )
    Mgas_Msun = res["Mgas_Msun"]
    print(f"fH2_avg: {res['fH2_avg']:.6e}, Mgas_Msun: {Mgas_Msun:.3e}")

    # Read collapse scalars (ensure float key for J21)
    jkey = float(j21_val)
    M_collapse_Msun = store[halo_name][jkey]["M_collapse_Msun"]
    z_collapse      = store[halo_name][jkey]["z_collapse"]

    print(f"z_collapse: {z_collapse:.1f}, M_collapse_Msun: {M_collapse_Msun:.3e}")
    print("Mgas/M_collapse:", Mgas_Msun / M_collapse_Msun)
    print("Omega_b/Omega_m:", Omega_b / Omega_m)

    # Plot profiles for multiple J21 values
    j21_list_halo6 = [0.1, 1.0, 10.0, 100.0, 1000.0]
    plot_profiles(
        halo_name, "fH2", j21_list_halo6,
        r_min_pc=1e-3, r_max_pc=1e3, n_samples=1000,
        store=store,                 # <-- pass store explicitly
    )
    # Example: also plot density if desired
    # plot_profiles(halo_name, "density", j21_list_halo6, store=store)

